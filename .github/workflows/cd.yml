name: CD (Schematics with CE fallback)

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]
  workflow_dispatch:
    inputs:
      image_tag:
        description: "Image tag to deploy (e.g., latest or sha-abcdef)"
        required: false
        default: latest

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

env:
  REGION: eu-gb
  RESOURCE_GROUP: Default
  WORKSPACE_NAME: movie-watchlist-api
  IMAGE_NAME: ghcr.io/${{ github.repository_owner }}/movie-watchlist-api
  IMAGE_TAG: ${{ inputs.image_tag || 'latest' }}

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    environment: prod
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Compose image reference
        run: echo "IMAGE_REFERENCE=${IMAGE_NAME}:${IMAGE_TAG}" >> "$GITHUB_ENV"

      - name: Install IBM Cloud CLI + Schematics plugin
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq curl
          curl -fsSL https://clis.cloud.ibm.com/install/linux | sh
          ibmcloud plugin install schematics -f

      - name: IBM Cloud login & target
        env:
          IBMCLOUD_API_KEY: ${{ secrets.IBMCLOUD_API_KEY }}
        run: |
          ibmcloud login --apikey "$IBMCLOUD_API_KEY" -r "$REGION"
          ibmcloud target -g "$RESOURCE_GROUP"

      - name: Resolve workspace & template IDs
        id: ids
        run: |
          WS_JSON=$(ibmcloud schematics workspace list --output json)
          WS_ID=$(echo "$WS_JSON" | jq -r --arg NAME "$WORKSPACE_NAME" '.workspaces[]? | select(.name==$NAME) | .id' | head -n1)
          if [ -z "$WS_ID" ]; then
            echo "Workspace '$WORKSPACE_NAME' not found in region ${REGION}. Create it first."
            exit 1
          fi
          TID=$(ibmcloud schematics workspace get --id "$WS_ID" --output json | jq -r '.template_data[0].id')
          echo "id=$WS_ID" >> "$GITHUB_OUTPUT"
          echo "template=$TID" >> "$GITHUB_OUTPUT"
          echo "Workspace: $WS_ID"
          echo "Template:  $TID"

      - name: Pull latest repo into workspace
        run: ibmcloud schematics workspace update --id "${{ steps.ids.outputs.id }}" --pl

      # ---------- Wait helper (unlocks) ----------
      - name: Create wait script
        run: |
          cat > wait_ws.sh <<'EOF'
          #!/usr/bin/env bash
          set -euo pipefail
          WS_ID="$1"
          LABEL="$2"
          # wait up to ~5 minutes
          for i in {1..20}; do
            STATUS=$(ibmcloud schematics workspace get --id "$WS_ID" --output json | jq -r '.status')
            echo "[$LABEL] Status: $STATUS"
            case "$STATUS" in
              ACTIVE|DRAFT|INACTIVE) exit 0 ;;
              *) sleep 15 ;;
            esac
          done
          echo "Timed out waiting for workspace unlock ($LABEL)"; exit 1
          EOF
          chmod +x wait_ws.sh

      # ---------- Update variable (image_reference) with retry ----------
      - name: Prepare variable file
        run: |
          jq -n \
            --arg img "$IMAGE_REFERENCE" \
            '{
              variablestore: [
                {name:"image_reference", value:$img, type:"string", secure:false}
              ]
            }' > vars.json
          cat vars.json

      - name: Wait for unlock (pre-update-variables)
        run: ./wait_ws.sh "${{ steps.ids.outputs.id }}" "update-variables"

      - name: Update workspace variables (retry on 409)
        run: |
          for i in {1..6}; do
            if ibmcloud schematics workspace update-variables \
              --id "${{ steps.ids.outputs.id }}" \
              --template "${{ steps.ids.outputs.template }}" \
              --file vars.json; then
              echo "Variables updated."
              exit 0
            fi
            echo "update-variables failed (likely 409 lock). Retry $i/6 in 20s..."
            sleep 20
          done
          echo "Failed to update variables after retries."
          exit 1

      # ---------- Plan with robust retry ----------
      - name: Wait for unlock (pre-plan)
        run: ./wait_ws.sh "${{ steps.ids.outputs.id }}" "plan"

      - name: Plan (Schematics) with retry
        id: planstep
        run: |
          set -euo pipefail
          WS_ID="${{ steps.ids.outputs.id }}"
          PLAN_OK=false
          # backoff: 30s, 60s, 90s, 120s, 150s, 180s, 210s, 240s
          for i in 1 2 3 4; do
            echo "Attempt $i: schematics plan..."
            if ibmcloud schematics plan --id "$WS_ID" --var-file vars.json; then
              PLAN_OK=true
              break
            fi
            echo "Plan failed (transient 409/500?). Sleeping..."
            sleep $(( 30*i + RANDOM % 10 ))
          done
          echo "plan_ok=$PLAN_OK" >> "$GITHUB_OUTPUT"

      # ---------- Apply with retry if plan succeeded ----------
      - name: Wait for unlock (pre-apply)
        if: steps.planstep.outputs.plan_ok == 'true'
        run: ./wait_ws.sh "${{ steps.ids.outputs.id }}" "apply"

      - name: Apply (Schematics) with retry
        if: steps.planstep.outputs.plan_ok == 'true'
        id: applystep
        run: |
          set -euo pipefail
          WS_ID="${{ steps.ids.outputs.id }}"
          APPLY_OK=false
          for i in 1 2 3 4 5; do
            echo "Attempt $i: schematics apply..."
            if ibmcloud schematics apply --id "$WS_ID" --var-file vars.json --force; then
              APPLY_OK=true
              break
            fi
            echo "Apply failed (transient?). Sleeping..."
            sleep $(( 30*i + RANDOM % 10 ))
          done
          echo "apply_ok=$APPLY_OK" >> "$GITHUB_OUTPUT"

      # ---------- Fallback: direct Code Engine deploy if plan failed ----------
      - name: Fallback deploy via Code Engine (update image)
        if: steps.planstep.outputs.plan_ok != 'true'
        env:
          CE_PROJECT_NAME: movie-watchlist-project
          APP_NAME: movie-watchlist
        run: |
          set -euo pipefail
          echo "Schematics plan failed after retries; performing fallback CE image update."
          ibmcloud plugin install code-engine -f >/dev/null
          ibmcloud ce project select --name "$CE_PROJECT_NAME"
          ibmcloud ce app update --name "$APP_NAME" --image "${IMAGE_REFERENCE}"
          echo "Fallback deploy completed."

      # ---------- Outputs ----------
      - name: Fetch outputs (App URL)
        id: outputs
        continue-on-error: true
        run: |
          set -euo pipefail
          APP_URL=""
          if [ "${{ steps.planstep.outputs.plan_ok }}" = "true" ] && [ "${{ steps.applystep.outputs.apply_ok || 'false' }}" = "true" ]; then
            OJSON=$(ibmcloud schematics output --id "${{ steps.ids.outputs.id }}" --output json || true)
            echo "$OJSON" > outputs.json
            APP_URL=$(echo "$OJSON" | jq -r '.[]? | select(.name=="app_url") | .value // empty' | head -n1)
          else
            # Best-effort derive CE URL if Schematics path didn't complete
            ibmcloud plugin install code-engine -f >/dev/null
            ibmcloud ce app get --name movie-watchlist --output json > ce_app.json || true
            APP_URL=$(jq -r '.status?.url // .status?.urls?[0] // empty' ce_app.json || true)
            cp ce_app.json outputs.json || true
          fi
          echo "url=$APP_URL" >> "$GITHUB_OUTPUT"
          {
            echo "## Deployment result"
            echo
            if [ -n "$APP_URL" ]; then
              echo "- **App URL:** [$APP_URL]($APP_URL)"
            else
              echo "- **App URL:** (none found)"
            fi
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Upload outputs artifact
        uses: actions/upload-artifact@v4
        with:
          name: deploy-outputs-${{ github.sha }}
          path: outputs.json

      # ---------- DAST ----------
      - name: OWASP ZAP Baseline Scan
        if: steps.outputs.outputs.url != ''
        uses: zaproxy/action-baseline@v0.11.0
        with:
          target: ${{ steps.outputs.outputs.url }}/docs
          allow_issue_writing: false
          cmd_options: '-a'
        continue-on-error: true
