name: CD (Schematics)

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]
  workflow_dispatch:
    inputs:
      image_tag:
        description: "Image tag to deploy (e.g., latest or sha)"
        required: false
        default: latest

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

env:
  REGION: eu-gb
  RESOURCE_GROUP: Default
  WORKSPACE_NAME: movie-watchlist-api
  IMAGE_NAME: ghcr.io/${{ github.repository_owner }}/movie-watchlist-api
  IMAGE_TAG: ${{ inputs.image_tag || 'latest' }}

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    environment: prod

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Compose image reference
        run: echo "IMAGE_REFERENCE=${IMAGE_NAME}:${IMAGE_TAG}" >> "$GITHUB_ENV"

      - name: Install IBM Cloud CLI + Schematics plugin
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq curl
          curl -fsSL https://clis.cloud.ibm.com/install/linux | sh
          ibmcloud plugin install schematics -f

      - name: IBM Cloud login & target
        env:
          IBMCLOUD_API_KEY: ${{ secrets.IBMCLOUD_API_KEY }}
        run: |
          ibmcloud login --apikey "$IBMCLOUD_API_KEY" -r "$REGION"
          ibmcloud target -g "$RESOURCE_GROUP"

      - name: Resolve workspace and template IDs
        id: ids
        run: |
          WS_ID=$(ibmcloud schematics workspace list --output json \
            | jq -r --arg NAME "$WORKSPACE_NAME" '.workspaces[]? | select(.name==$NAME) | .id' | head -n1)
          if [ -z "$WS_ID" ]; then
            echo "Workspace '$WORKSPACE_NAME' not found. Please create it first."
            exit 1
          fi
          TEMPLATE_ID=$(ibmcloud schematics workspace get --id "$WS_ID" --output json \
            | jq -r '.template_data[0].id')
          echo "id=$WS_ID" >> "$GITHUB_OUTPUT"
          echo "template=$TEMPLATE_ID" >> "$GITHUB_OUTPUT"
          echo "Workspace ID: $WS_ID"
          echo "Template ID: $TEMPLATE_ID"

      - name: Pull latest code into workspace
        run: ibmcloud schematics workspace update --id "${{ steps.ids.outputs.id }}" --pl

      - name: Update workspace variables
        run: |
          jq -n \
            --arg img "$IMAGE_REFERENCE" \
            '{
              variablestore: [
                {name:"image_reference", value:$img, type:"string", secure:false}
              ]
            }' > vars.json
          ibmcloud schematics workspace update-variables \
            --id "${{ steps.ids.outputs.id }}" \
            --template "${{ steps.ids.outputs.template }}" \
            --file vars.json

      - name: Wait for workspace unlock
        run: |
          for i in {1..10}; do
            STATUS=$(ibmcloud schematics workspace get --id "${{ steps.ids.outputs.id }}" --output json | jq -r '.status')
            if [[ "$STATUS" != "INPROGRESS" && "$STATUS" != "LOCKED" ]]; then
              echo "Workspace is ready."
              break
            fi
            echo "Workspace locked... waiting 30s"
            sleep 30
          done

      - name: Plan (Schematics)
        run: ibmcloud schematics plan --id "${{ steps.ids.outputs.id }}" --var-file vars.json

      - name: Apply (Schematics)
        run: ibmcloud schematics apply --id "${{ steps.ids.outputs.id }}" --var-file vars.json --force

      - name: Fetch Outputs (App URL)
        id: output
        run: |
          OJSON=$(ibmcloud schematics output --id "${{ steps.ids.outputs.id }}" --output json || true)
          echo "$OJSON" | tee outputs.json
          APP_URL=$(echo "$OJSON" | jq -r '.[]? | select(.name=="app_url") | .value // empty' | head -n1)
          echo "url=$APP_URL" >> "$GITHUB_OUTPUT"
          echo "## Terraform outputs" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          if [ -n "$APP_URL" ]; then
            echo "- **App URL:** [$APP_URL]($APP_URL)" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "- **App URL:** (none)" >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Upload outputs
        uses: actions/upload-artifact@v4
        with:
          name: schematics-outputs-${{ github.sha }}
          path: outputs.json
