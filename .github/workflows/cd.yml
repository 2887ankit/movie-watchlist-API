name: CD

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]
  workflow_dispatch:

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

env:
  TF_WORKING_DIR: terraform
  IMAGE_REFERENCE: ghcr.io/${{ github.repository_owner }}/movie-watchlist-api:latest

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    environment:
      name: prod               
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      - name: Terraform init
        working-directory: ${{ env.TF_WORKING_DIR }}
        env:
          IBMCLOUD_API_KEY: ${{ secrets.IBMCLOUD_API_KEY }}
        run: terraform init -input=false

      - name: Terraform validate
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform validate

      - name: Terraform plan
        working-directory: ${{ env.TF_WORKING_DIR }}
        env:
          IBMCLOUD_API_KEY: ${{ secrets.IBMCLOUD_API_KEY }}
        run: terraform plan -input=false -no-color \
            -var "image_reference=${{ env.IMAGE_REFERENCE }}" \
            -out tfplan
          terraform show -no-color tfplan > plan.txt

      - name: Terraform apply
        working-directory: ${{ env.TF_WORKING_DIR }}
        env:
          IBMCLOUD_API_KEY: ${{ secrets.IBMCLOUD_API_KEY }}
        run: terraform apply -input=false -auto-approve tfplan
      - name: Show Terraform outputs (App URL)
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
            echo "## Terraform outputs" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            terraform output
            APP_URL=$(terraform output -raw app_url || true)
            if [ -n "$APP_URL" ]; then
                echo "- **App URL:** [$APP_URL]($APP_URL)" >> "$GITHUB_STEP_SUMMARY"
                echo "App URL: $APP_URL"
            else
                echo "- **App URL:** (none)" >> "$GITHUB_STEP_SUMMARY"
            fi