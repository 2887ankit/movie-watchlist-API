name: CD (Schematics)

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]
  workflow_dispatch:
    inputs:
      image_tag:
        description: "Image tag to deploy (e.g., latest or sha-abcdef)"
        required: false
        default: latest

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

env:
  REGION: eu-gb
  RESOURCE_GROUP: Default
  WORKSPACE_NAME: movie-watchlist-api
  IMAGE_NAME: ghcr.io/${{ github.repository_owner }}/movie-watchlist-api
  IMAGE_TAG: ${{ inputs.image_tag || 'latest' }}

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    environment: prod
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Compose image reference
        run: echo "IMAGE_REFERENCE=${IMAGE_NAME}:${IMAGE_TAG}" >> "$GITHUB_ENV"

      - name: Install IBM Cloud CLI + Schematics plugin
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq curl
          curl -fsSL https://clis.cloud.ibm.com/install/linux | sh
          ibmcloud plugin install schematics -f

      - name: IBM Cloud login & target
        env:
          IBMCLOUD_API_KEY: ${{ secrets.IBMCLOUD_API_KEY }}
        run: |
          ibmcloud login --apikey "$IBMCLOUD_API_KEY" -r "$REGION"
          ibmcloud target -g "$RESOURCE_GROUP"

      - name: Resolve workspace & template IDs
        id: ids
        run: |
          WS_JSON=$(ibmcloud schematics workspace list --output json)
          WS_ID=$(echo "$WS_JSON" | jq -r --arg NAME "$WORKSPACE_NAME" '.workspaces[]? | select(.name==$NAME) | .id' | head -n1)
          if [ -z "$WS_ID" ]; then
            echo "Workspace '$WORKSPACE_NAME' not found in region ${REGION}. Create it first."
            exit 1
          fi
          TID=$(ibmcloud schematics workspace get --id "$WS_ID" --output json | jq -r '.template_data[0].id')
          echo "id=$WS_ID" >> "$GITHUB_OUTPUT"
          echo "template=$TID" >> "$GITHUB_OUTPUT"
          echo "Workspace: $WS_ID"
          echo "Template:  $TID"

      - name: Pull latest repo into workspace
        run: ibmcloud schematics workspace update --id "${{ steps.ids.outputs.id }}" --pl

      # ------- helpers --------
      - name: Create helper (wait until workspace is unlocked)
        run: |
          cat > wait_ws.sh <<'EOF'
          #!/usr/bin/env bash
          set -euo pipefail
          WS_ID="$1"
          LABEL="$2"
          # wait up to ~5 minutes
          for i in {1..20}; do
            STATUS=$(ibmcloud schematics workspace get --id "$WS_ID" --output json | jq -r '.status')
            echo "[$LABEL] Status: $STATUS"
            case "$STATUS" in
              ACTIVE|DRAFT|INACTIVE) exit 0 ;;
              *) sleep 15 ;;
            esac
          done
          echo "Timed out waiting for workspace unlock ($LABEL)"; exit 1
          EOF
          chmod +x wait_ws.sh

      - name: Prepare vars.json
        run: |
          jq -n \
            --arg img "$IMAGE_REFERENCE" \
            '{
              variablestore: [
                {name:"image_reference", value:$img, type:"string", secure:false}
              ]
            }' > vars.json
          cat vars.json

      - name: Wait (before update-variables)
        run: ./wait_ws.sh "${{ steps.ids.outputs.id }}" "update-variables"

      - name: Update workspace variables (retry 409/500)
        run: |
          for i in {1..6}; do
            if ibmcloud schematics workspace update-variables \
              --id "${{ steps.ids.outputs.id }}" \
              --template "${{ steps.ids.outputs.template }}" \
              --file vars.json; then
              echo "Variables updated."; exit 0
            fi
            echo "update-variables failed; retry $i/6 in 20s..."
            sleep 20
          done
          echo "Could not update variables after retries."; exit 1

      - name: Wait (before plan)
        run: ./wait_ws.sh "${{ steps.ids.outputs.id }}" "plan"

      - name: Plan (retry transient 500s)
        run: |
          for i in {1..5}; do
            if ibmcloud schematics plan --id "${{ steps.ids.outputs.id }}" --var-file vars.json; then
              exit 0
            fi
            echo "Plan failed; retry $i/5 in 60s..."
            sleep 60
          done
          echo "Plan failed after retries."; exit 1

      - name: Wait (before apply)
        run: ./wait_ws.sh "${{ steps.ids.outputs.id }}" "apply"

      - name: Apply (retry transient 500s)
        run: |
          for i in {1..5}; do
            if ibmcloud schematics apply --id "${{ steps.ids.outputs.id }}" --var-file vars.json --force; then
              exit 0
            fi
            echo "Apply failed; retry $i/5 in 60s..."
            sleep 60
          done
          echo "Apply failed after retries."; exit 1

      - name: Fetch outputs (App URL)
        id: outputs
        run: |
          OJSON=$(ibmcloud schematics output --id "${{ steps.ids.outputs.id }}" --output json || true)
          echo "$OJSON" | tee outputs.json
          APP_URL=$(echo "$OJSON" | jq -r '.[]? | select(.name=="app_url") | .value // empty' | head -n1)
          echo "url=$APP_URL" >> "$GITHUB_OUTPUT"
          {
            echo "## Terraform outputs"
            echo
            if [ -n "$APP_URL" ]; then
              echo "- **App URL:** [$APP_URL]($APP_URL)"
            else
              echo "- **App URL:** (none)"
            fi
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Upload outputs artifact
        uses: actions/upload-artifact@v4
        with:
          name: schematics-outputs-${{ github.sha }}
          path: outputs.json

      - name: OWASP ZAP Baseline Scan
        if: ${{ steps.outputs.outputs.url != '' }}
        uses: zaproxy/action-baseline@v0.11.0
        with:
          target: ${{ steps.outputs.outputs.url }}/docs
          allow_issue_writing: false
          cmd_options: '-a'
        continue-on-error: true